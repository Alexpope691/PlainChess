/*
 * PlainChess v1.2
 * http://plainchess.timwoelfle.de
 *
 * Copyright by Tim Wölfle (http://timwoelfle.de)
 * Licensed under the GPL Version 3 license (http://www.gnu.org/licenses/gpl-3.0.txt)
 *
 */

var game,sync,menu,controller;function Game(e){var t,n,i,o,a,l,c,r,s={"♙":{color:"white",kind:"pawn"},"♘":{color:"white",kind:"knight"},"♗":{color:"white",kind:"bishop"},"♖":{color:"white",kind:"rook"},"♕":{color:"white",kind:"queen"},"♔":{color:"white",kind:"king"},"♟":{color:"black",kind:"pawn"},"♞":{color:"black",kind:"knight"},"♝":{color:"black",kind:"bishop"},"♜":{color:"black",kind:"rook"},"♛":{color:"black",kind:"queen"},"♚":{color:"black",kind:"king"}},u=0,h=[],d=1,m={white:{queenSide:!0,kingSide:!0},black:{queenSide:!0,kingSide:!0}},p={};function f(){var e,t,n,i=h[h.length-1],o="";i&&i.stalemate?o="Stalemate!":i&&i.mate?(o="Mate! ",o+=sync?d===sync.playerIsWhite?"Opponent wins.":"You win.":d?"Black wins.":"White wins."):(i&&i.check&&(o="Check! "),o+=sync?d===sync.playerIsWhite?"Your turn.":"Opponent's turn.":d?"White's turn.":"Black's turn."),$("#currentTurn > span:first-child").html(o),e=h.length?"Last move: "+("king"===s[(t=i).pieceSymbol].kind&&Math.abs(t.startColumn-t.endColumn)>1?3===t.endColumn?"O-O-O":"O-O":(n="white"===s[t.pieceSymbol].color?t.pieceSymbol:'<span style="color: black">'+t.pieceSymbol+"</span>",n+=String.fromCharCode(96+t.startColumn),n+=t.startRow,n+=" ",t.capturedPieceSymbol&&(n+="white"===s[t.capturedPieceSymbol].color?t.capturedPieceSymbol:'<span style="color: black">'+t.capturedPieceSymbol+"</span>"),n+=String.fromCharCode(96+t.endColumn),n+=t.endRow,t.promotionType?(n+="=",n+="white"===s[t.pieceSymbol].color?t.promotionType:'<span style="color: black">'+t.promotionType+"</span>"):t.enPassant&&(n+=" e.p."),t.check&&!t.mate&&(n+="+"),(t.mate||t.stalemate)&&(n+="#"),n)):"No move yet.",$("#lastMove").html(e)}function g(){var e,t,n="";u++,n+=(e=Math.floor(u/60))<10?"0"+e:e,n+=":",n+=(t=u%60)<10?"0"+t:t,$("#gameTime").html(n)}function b(){$(".promotion").fadeOut(300,function(){$(".promotion > ul > li").off().remove(),$(".promotion")[0].id="",$(".promotion").css("left","")})}function k(e,t){return t?$(e).data("pieceObject",t):$(e).data("pieceObject")}function w(e,t){return t?$(e).data("fieldObject",t):$(e).data("fieldObject")}function y(){var e;d=d?0:1,k($("td > .piece.king."+(d?"white":"black"))).field.reachableBy[d?"black":"white"].length&&(h[h.length-1].check=!0),$(d?"td > .white":"td> .black").each(function(t,n){if(k(n).accessibleFields().length)return e=!0,!1}),e||(h[h.length-1].check?(h[h.length-1].mate=!0,$("#end > .tone100 > h2 > span:first-child").css("background-position",d?"-180px 100%":"0 100%"),$("#end > .tone100 > h2 > span:last-child").html(d?"Black wins":"White wins")):(h[h.length-1].stalemate=!0,$("#end > .tone100 > h2 > span:first-child").css("background-position","-360px 100%"),$("#end > .tone100 > h2 > span:last-child").html("Stalemate")),game.gameOver=!0,clearInterval(n)),h[h.length-1].check?h[h.length-1].mate?controller.blink($("td > .piece.king."+(d?"white":"black")),3,1e3,function(){menu||(menu=new Menu("#end")).appear(!0)}):controller.blink($("td > .piece.king."+(d?"white":"black")),2,1e3):h[h.length-1].stalemate&&controller.blink($("td > .piece.king"),3,1e3,function(){menu||(menu=new Menu("#end")).appear(!0)}),f(),controller.autoSave&&game.updateLocalStorage(),sync&&sync.playerIsWhite!==d&&sync.makeMove(h[h.length-1])}function v(e){var n=this;function i(){("king"===n.kind||"rook"===n.kind&&1===n.field.column)&&(m[n.color].queenSide=!1),("king"===n.kind||"rook"===n.kind&&8===n.field.column)&&(m[n.color].kingSide=!1)}k(e,this),this.element=e,this.symbol=e.innerHTML,this.kind=s[this.symbol].kind,this.color=s[this.symbol].color,this.isWhite="white"===this.color?1:0,this.field=w(e.parentNode),this.reachableFields=[],this.getReachableFields=function(){function e(e,t){this.add=function(n,i){return!(!p[e+n]||!p[e+n][t+i])&&this.push(p[e+n][t+i])}}e.prototype=[];var t,i=new e(this.field.column,this.field.row),o=n.isWhite?1:-1;switch(this.kind){case"pawn":i.add(-1,o),i.add(1,o);break;case"knight":i.add(-1,2),i.add(1,2),i.add(-1,-2),i.add(1,-2),i.add(-2,1),i.add(-2,-1),i.add(2,1),i.add(2,-1);break;case"king":i.add(-1,1),i.add(0,1),i.add(1,1),i.add(-1,0),i.add(1,0),i.add(-1,-1),i.add(0,-1),i.add(1,-1);break;case"bishop":case"rook":case"queen":"bishop"!==this.kind&&$.each([[-1,0],[1,0],[0,-1],[0,1]],function(e,n){for(t=1;i.add(n[0]*t,n[1]*t)&&!i[i.length-1].piece;t++);}),"rook"!==this.kind&&$.each([[-1,1],[-1,-1],[1,1],[1,-1]],function(e,n){for(t=1;i.add(n[0]*t,n[1]*t)&&!i[i.length-1].piece;t++);})}return i},this.captureableFields=function(){var e=this.reachableFields,t=[];return $.each(e,function(e,i){i.piece?i.piece.isWhite!==n.isWhite&&t.push(i):"pawn"!==n.kind&&t.push(i)}),t},this.accessibleFields=function(){var e,t,i,o,a=this.captureableFields(),l=n.isWhite?1:-1,c=n.isWhite?1:8,r=k($("td > .piece.king."+(d?"white":"black"))),u=r.field.reachableBy[this.isWhite?"black":"white"];switch(this.kind){case"pawn":p[this.field.column][this.field.row+l]&&!p[this.field.column][this.field.row+l].piece&&a.push(p[this.field.column][this.field.row+l]),this.field.row!==c+l||p[this.field.column][this.field.row+l].piece||p[this.field.column][this.field.row+2*l].piece||a.push(p[this.field.column][this.field.row+2*l]),this.field.row===c+4*l&&h.length&&"pawn"===s[h[h.length-1].pieceSymbol].kind&&h[h.length-1].endRow===this.field.row&&2===Math.abs(h[h.length-1].startRow-h[h.length-1].endRow)&&1===Math.abs(h[h.length-1].startColumn-this.field.column)&&a.push(p[h[h.length-1].startColumn][this.field.row+l]);break;case"king":return!m[this.color].queenSide||!p[1][c].piece||"rook"!==p[1][c].piece.kind||p[2][c].piece||p[3][c].piece||p[4][c].piece||p[3][c].reachableBy[n.isWhite?"black":"white"].length||p[4][c].reachableBy[n.isWhite?"black":"white"].length||p[5][c].reachableBy[n.isWhite?"black":"white"].length||a.push(p[3][c]),!m[this.color].kingSide||!p[8][c].piece||"rook"!==p[8][c].piece.kind||p[6][c].piece||p[7][c].piece||p[7][c].reachableBy[n.isWhite?"black":"white"].length||p[6][c].reachableBy[n.isWhite?"black":"white"].length||p[5][c].reachableBy[n.isWhite?"black":"white"].length||a.push(p[7][c]),e=a,a=[],$.each(e,function(e,t){t.reachableBy[n.isWhite?"black":"white"].length||($.each(u,function(e,i){n.field.inBetween(i.field,t)||a.push(t)}),u.length||a.push(t))}),a}if(u.length){if(e=a,a=[],u.length>1)return[];$.each(e,function(e,t){"bishop"!==u[0].kind&&"rook"!==u[0].kind&&"queen"!==u[0].kind||t.inBetween(r.field,u[0].field)&&a.push(t),t===u[0].field&&a.push(t)})}else $.each([[-1,0],[1,0],[0,-1],[0,1],[-1,1],[-1,-1],[1,1],[1,-1]],function(l,c){if(!p[n.field.column+c[0]]||!(i=p[n.field.column+c[0]][n.field.row+c[1]]))return!0;if(n.field.inBetween(i,r.field))for(t=1;p[r.field.column+c[0]*t]&&(i=p[r.field.column+c[0]*t][r.field.row+c[1]*t]);t++)if(i.piece){if(i.piece===n){o=!0;continue}return o&&i.piece.isWhite!==n.isWhite&&("queen"===i.piece.kind||"bishop"===i.piece.kind&&l>3||"rook"===i.piece.kind&&l<4)&&(e=a,a=[],$.each(e,function(e,t){(t.inBetween(r.field,i)||t===i)&&a.push(t)})),!1}});return a},this.updateReachables=function(){function e(e){e.reachableBy.white.length!==e.reachableBy.black.length?e.element.className="property"+(e.reachableBy.white.length-e.reachableBy.black.length):e.element.className="neutral"+e.reachableBy.white.length}if($.each(this.reachableFields,function(t,i){-1!==(t=i.reachableBy[n.color].indexOf(n))&&(i.reachableBy[n.color].splice(t,1),e(i))}),!this.field)return!1;this.reachableFields=this.getReachableFields(),$.each(this.reachableFields,function(t,i){i.reachableBy[n.color].push(n),e(i)})},this.moveToCemetery=function(){var t;"rook"===this.kind&&i(),t=$("<li />").appendTo($("#"+this.color+"Cemetery")),this.moveInDOM(t,!0,!0),$(e).hasClass("ui-draggable")&&$(e).draggable("destroy")},this.move=function(e,t){var o,a;if(h.push({startColumn:n.field.column,startRow:n.field.row,endColumn:e.column,endRow:e.row,pieceSymbol:n.symbol}),o=p[e.column][e.row].piece,"pawn"!==n.kind||n.field.column===e.column||o||(o=p[e.column][e.row+(n.isWhite?-1:1)].piece,h[h.length-1].enPassant=!0),o&&(h[h.length-1].capturedPieceSymbol=o.symbol,o.moveToCemetery()),("♔"===n.symbol&&1===e.row||"♚"===n.symbol&&8===e.row)&&(3===e.column&&m[n.color].queenSide||7===e.column&&m[n.color].kingSide)&&((a={}).row="♔"===n.symbol?1:8,a.startColumn=3===e.column?1:8,a.endColumn=3===e.column?4:6,a.tower=p[a.startColumn][a.row].piece,a.tower.moveInDOM(p[a.endColumn][a.row].element,!0)),"rook"!==n.kind&&"king"!==n.kind||i(),n.moveInDOM(e.element),"♙"===n.symbol&&8===e.row||"♟"===n.symbol&&1===e.row)return n.promote(t);y()},this.animateMove=function(t,i){$(e).css("position","relative").animate({left:$(t.element).offset().left-$(this.field.element).offset().left,top:$(t.element).offset().top-$(this.field.element).offset().top},1e3,"easeInOutQuad",function(){a&&(a=!1),n.move(t,i)})},this.startDragging=function(){var e;return $("#board td").removeClass("acceptable").off("click"),!(d!==this.isWhite||a||h[h.length-1]&&(h[h.length-1].mate||h[h.length-1].stalemate)||$(".promotion").is(":visible"))&&($("#board td").droppable("option","accept",""),e=this.accessibleFields(),$.each(e,function(e,t){$(t.element).droppable("option","accept",".piece")}),!0)},this.clickPiece=function(){if(d!==this.isWhite||a||h[h.length-1]&&(h[h.length-1].mate||h[h.length-1].stalemate)||$(".promotion").is(":visible"))return!0;function e(){$("#board td").removeClass("acceptable").off("click")}return e(),$("#board td").on("click",function(){e()}),$.each(this.accessibleFields(),function(t,i){$(i.element).addClass("acceptable"),$(i.element).on("click",function(){a=!0,e(),n.animateMove(i)})}),!1},this.promote=function(i){var o;i?(n.symbol=e.innerHTML=i,n.kind=s[i].kind,h[h.length-1].promotionType=i,t[h[h.length-1].endColumn][h[h.length-1].endRow]=i,n.updateReachables(),y(),b(),controller.flip(e,"horizontal",1e3,function(){$(e).removeClass("pawn"),$(e).addClass(n.kind)})):($.each(this.isWhite?["♘","♗","♖","♕"]:["♞","♝","♜","♛"],function(e,t){$('<li><div class="piece '+s[t].color+" "+s[t].kind+'">'+t+"</div></li>").appendTo($(".promotion > ul")).on("click",function(){n.promote(t)})}),o=sync?!sync.playerIsWhite:0,$(".promotion")[0].id=this.isWhite||o?"top":"bottom",$(".promotion").css("left",60*Math.abs(this.field.column-9*o)-130+"px"),$(".promotion").fadeIn(300))},this.moveInDOM=function(n,i,o){var a,l,c;a=this.field.reachableBy.white.concat(this.field.reachableBy.black),t[this.field.column][this.field.row]="",this.field.piece=void 0,this.field=void 0,$.each(a,function(e,t){"bishop"!==t.kind&&"rook"!==t.kind&&"queen"!==t.kind||t.updateReachables()}),i&&(l=$(e).offset().left,c=$(e).offset().top),$(n).append(e),i?(o&&controller.spin(e,1e3),$(e).css({position:"relative",left:l-$(e).offset().left+"px",top:c-$(e).offset().top+"px"}).animate({left:"0",top:"0"},1e3,"easeInOutQuad")):$(e).css({left:"0",top:"0"}),w(n)&&(t[w(n).column][w(n).row]=this.symbol,this.field=w(n),this.field.piece=this,$.each(this.field.reachableBy.white.concat(this.field.reachableBy.black),function(e,t){"bishop"!==t.kind&&"rook"!==t.kind&&"queen"!==t.kind||t.updateReachables()})),this.updateReachables()}}function S(e){w(e,this),this.element=e,this.column=parseInt(e.id.substr(0,1),10),this.row=parseInt(e.id.substr(1,1),10),this.piece=e.firstChild?k(e.firstChild):void 0,this.reachableBy={white:[],black:[]},this.createPiece=function(t){this.piece=new v($('<div class="piece '+s[t].color+" "+s[t].kind+'">'+t+"</div>").appendTo(e)[0])},this.inBetween=function(e,t){return e.column===t.column&&this.column===e.column?this.row<e.row&&this.row>t.row||this.row>e.row&&this.row<t.row:e.row===t.row&&this.row===e.row?this.column<e.column&&this.column>t.column||this.column>e.column&&this.column<t.column:Math.abs(e.column-t.column)===Math.abs(e.row-t.row)&&(Math.abs(e.column-this.column)===Math.abs(e.row-this.row)&&Math.abs(e.column-this.column)<Math.abs(e.column-t.column)&&Math.abs(t.column-this.column)<Math.abs(e.column-t.column)&&Math.abs(e.row-this.row)<Math.abs(e.row-t.row)&&Math.abs(t.row-this.row)<Math.abs(e.row-t.row))}}return l=sync?sync.playerIsWhite:1,$("#board td").each(function(e,t){c=Math.abs(Math.floor(e/8)-7*l)+1,r=Math.abs(e%8-7*Math.abs(l-1))+1,t.setAttribute("id",r+""+c),p[r]=p[r]||{},p[r][c]=new S(t)}),$("th").each(function(e,t){t.innerHTML=e<8?Math.abs(e-7*l)+1:String.fromCharCode(96+Math.abs(e-8-7*Math.abs(l-1))+1)}),e&&(d=e.whitesTurn,t=e.gameState,m=e.castlingAllowed,u=e.gameTime,h=e.moves,$.each(h,function(e,t){t.capturedPieceSymbol&&$('<li><div class="piece '+s[t.capturedPieceSymbol].color+" "+s[t.capturedPieceSymbol].kind+'">'+t.capturedPieceSymbol+"</div></li>").appendTo($("#"+s[t.capturedPieceSymbol].color+"Cemetery"))}),h.length&&(h[h.length-1].mate||h[h.length-1].stalemate)&&(o=!0,h[h.length-1].mate?($("#end > .tone100 > h2 > span:first-child").css("background-position",d?"30% 100%":"0 100%"),$("#end > .tone100 > h2 > span:last-child").html(d?"Black wins":"White wins")):($("#end > .tone100 > h2 > span:first-child").css("background-position","60% 100%"),$("#end > .tone100 > h2 > span:last-child").html("Stalemate")))),t=t||{1:{1:"♖",2:"♙",7:"♟",8:"♜"},2:{1:"♘",2:"♙",7:"♟",8:"♞"},3:{1:"♗",2:"♙",7:"♟",8:"♝"},4:{1:"♕",2:"♙",7:"♟",8:"♛"},5:{1:"♔",2:"♙",7:"♟",8:"♚"},6:{1:"♗",2:"♙",7:"♟",8:"♝"},7:{1:"♘",2:"♙",7:"♟",8:"♞"},8:{1:"♖",2:"♙",7:"♟",8:"♜"}},$.each(p,function(e,n){$.each(n,function(n,i){t[e]&&t[e][n]&&p[e][n].createPiece(t[e][n])})}),$("td > .piece").each(function(e,t){k(t).updateReachables()}),$("td > .white.knight:first, td > .black.knight:first").css("transform","scaleX(-1)"),$("td > .piece").each(function(e,t){sync&&sync.playerIsWhite!==k(t).isWhite||($(t).draggable({containment:$("#board"),revert:"invalid",start:function(e,t){return k(t.helper[0]).startDragging()}}),$(t).on("click",function(){return k(this).clickPiece()}))}),$("#board td").droppable({addClasses:!1,accept:"",activeClass:"acceptable",drop:function(e,t){return k(t.draggable[0]).move(w(this))}}),$("#border").hover(function(){menu||(i=setTimeout(function(){$("#border table").fadeIn(300)},500))},function(){$("#border table").fadeOut(300),clearInterval(i)}),f(),g(),540===$("#info").height()&&$("#info").clearQueue().animate({height:"570px"},100,"easeInQuad"),o||(n=setInterval(function(){g()},1e3)),{gameOver:o,deinit:function(){localStorage.clear(),controller.autoSave||(localStorage.noAutoSave=!0),b(),$(".piece").fadeOut(300,function(){$(this).parent("li").remove(),$(this).remove()}),$(".ui-draggable").draggable("destroy"),$("#board td").droppable("destroy"),$("#board td").removeClass(),clearInterval(n),570===$("#info").height()&&$("#info").clearQueue().animate({height:"540px"},100,"easeOutQuad"),$("#border").off()},fieldIsTaken:function(e,t){return!!(p[e]&&p[e][t]&&p[e][t].piece)},receiveCoordinates:function(e,t,n,i,o,a){var l,c,r,s;return l=document.getElementById(e+""+t),c=document.getElementById(n+""+i),r=l.firstChild,!!(l&&c&&r)&&($.each(k(r).accessibleFields(),function(e,t){w(c)===t&&(s=!0)}),a?controller.blink(r,2,1e3,function(){k(r).animateMove(w(c),o)}):k(r).animateMove(w(c),o),!!s)},updateLocalStorage:function(){localStorage.whitesTurn=d,localStorage.gameState=JSON.stringify(t),localStorage.castlingAllowed=JSON.stringify(m),localStorage.gameTime=u,localStorage.moves=JSON.stringify(h)}}}function Sync(){var e,t,n=1;function i(){document.title="PlainChess"!==document.title||n?"PlainChess":"Your turn!",n||setTimeout(function(){i()},1e3)}return $(window).on("focus",function(){n=1}),$(window).on("blur",function(){n=0}),{playerIsWhite:1,deinit:function(){clearInterval(t),$(window).off()},hostGame:function(n){$.post("php/hostGame.php",{id:n},function(n){n?(e=n,$("#hostGame > input[type='button']")[0].value="",$("#hostGame > input[type='button']").css("background","#5a4232 url(img/ajax-loader.gif) center no-repeat"),$("input[type='text']").attr("readonly",!0),$("input[type='button']").attr("disabled",!0),menu.deinit(),t=setInterval(function(){sync.waitForStart()},5e3),localStorage.gameName=e,localStorage.playerIsWhite=sync.playerIsWhite):menu.error(document.getElementById("hostGameName"),"Name already taken…")})},joinGame:function(n){$.post("php/joinGame.php",{id:n},function(n){n?(sync.playerIsWhite=0,e=n,game=new Game,menu.disappear(!0),t=setInterval(function(){sync.waitForMove()},5e3),localStorage.gameName=e,localStorage.playerIsWhite=sync.playerIsWhite):menu.error(document.getElementById("joinGameName"),"Game not hosted…")})},resumeGame:function(){if(!localStorage.gameName||!localStorage.playerIsWhite)return!1;e=localStorage.gameName,sync.playerIsWhite=parseInt(localStorage.playerIsWhite,10),localStorage.whitesTurn!=sync.playerIsWhite&&(t=setInterval(function(){sync.waitForMove()},5e3))},waitForStart:function(){$.post("php/waitForStart.php",{id:e},function(e){"joined"===e&&(i(),menu.disappear(!0),game=new Game,clearInterval(t))})},waitForMove:function(){var o,a,l,c,r;function s(e){game.receiveCoordinates(o,a,l,c,r,e)||alert("Invalid move received, maybe due to cheating. Games might be out of sync, restart is recommended.")}$.post("php/waitForMove.php",{id:e},function(e){"joined"!==e&&(o=parseInt(e.substr(0,1),10),a=parseInt(e.substr(1,1),10),l=parseInt(e.substr(3,1),10),c=parseInt(e.substr(4,1),10),e.substr(6,1)&&(r=e.substr(6,1)),game.fieldIsTaken(o,a)&&(clearInterval(t),n?s(0):(i(),$(window).on("focus",function(){n=1,s(1),$(window).off("focus"),$(window).on("focus",function(){n=1})}))))})},makeMove:function(n){$.post("php/makeMove.php",{id:e,startColumn:n.startColumn,startRow:n.startRow,endColumn:n.endColumn,endRow:n.endRow,promotionType:n.promotionType,gameOver:game.gameOver},function(e){e?t=setInterval(function(){sync.waitForMove()},5e3):alert("Error occured during sync! Game might have ended!")})}}}function Menu(e){var t,n,i,o,a,l;function c(e){if(l)return!1;n.each(function(t,n){$(n).children().clearQueue(),e!==t+1&&e?$(n).children().fadeTo(300,.3):$(n).children().fadeTo(300,1)})}function r(){t.on("mouseleave",function(e){c(0)}),n.each(function(e,t){t.id?($(t).on("mouseenter",function(){c(e+1)}),$(t).on("click",function(){$(t).children("input[type='text']").focus(),c(e+1)})):$(t).on("mouseenter",function(){c(0)}),$(t).children().each(function(t,n){$(n).on("focus",function(){c(e+1),l=1}),$(n).on("blur",function(){l=0,c(0)})})}),i.each(function(e,t){$(t).on("focus",function(){t.value===t.getAttribute("value")&&(t.value="")}),$(t).on("blur",function(){(""===t.value||$(t).hasClass("error"))&&(t.value=t.getAttribute("value"),$(t).removeClass("error"))}),$(t).on("keypress",function(e){if(13!==(e.keyCode?e.keyCode:e.which))return!$(t).hasClass("error")||(t.value="",$(t).removeClass("error"),!0);menu.menuOption(t.parentNode.id)})}),o.each(function(e,t){$(t).on("click",function(){menu.menuOption(t.parentNode.id)})}),a.each(function(e,t){$(t).on("click",function(){return menu.menuOption(t.parentNode.parentNode.id),!1})}),menu.initialized=!0}return t=$(e),n=t.children(),i=n.children("input[type='text']"),o=n.children("input[type='button']"),a=n.children("h2").children("a"),l=0,{name:e,initialized:!1,deinit:function(){t.off(),$(n).off(),$(n).children().off(),$(a).off()},appear:function(e){t.show(),e?n.each(function(e,t){$(t).css("left","-480px").animate({left:"0"},500+100*e,"easeOutQuad",function(){e===n.length-1&&r()})}):r()},disappear:function(e){function i(){t.hide(),menu&&(menu=void 0),$("input[type='text']")[0].value=$("input[type='text']")[0].getAttribute("value"),$("#hostGame > input[type='button']")[0].value="Go",$("#hostGame > input[type='button']").css("background",""),$("input[type='text']").attr("readonly",!1),$("input[type='button']").attr("disabled",!1)}menu.deinit(),e?n.each(function(e,t){$(t).animate({left:"480px"},400+100*(n.length-e),"easeInQuad",function(){e||i()})}):i(),menu&&(menu.initialized=!1)},error:function(e,t){e.value="",e.placeholder=t,$(e).addClass("error").focus()},menuOption:function(e){var t;switch(e){case"hostGame":if(!(t=document.getElementById("hostGameName").value.trim()))return menu.error(document.getElementById("hostGameName"),"Enter game name…");(sync=new Sync).hostGame(t);break;case"joinGame":if(!(t=document.getElementById("joinGameName").value.trim()))return menu.error(document.getElementById("joinGameName"),"Enter game name…");(sync=new Sync).joinGame(t);break;case"playOffline":game=new Game,menu.disappear(!0);break;case"toggleAutoSave":if(sync)break;controller.autoSave=!controller.autoSave,controller.autoSave?(localStorage.noAutoSave=void 0,game.updateLocalStorage()):localStorage.noAutoSave=!0,$("#toggleAutoSave > h2 > a > span:last-child").html(controller.autoSave?"on":"off"),controller.flip($("#pause > .tone55 > h2 span:first-child"),"horizontal",250,function(){$("#pause > .tone55 > h2 span:first-child").css("background-position",controller.autoSave?"60% 57.14%":"100% 85.71%")});break;case"playOn":menu.disappear(!0);break;case"quitGame":game=game.deinit(),sync&&(sync=sync.deinit()),menu=menu.disappear(),(menu=new Menu("#start")).appear(!0)}}}}controller=function(){function e(e){if($("#toggleFaq").hasClass("active"))return $("#toggleFaq").click(),!1;menu?"#start"!==menu.name&&menu.initialized&&menu.disappear(e):(menu=new Menu(game.gameOver?"#end":"#pause")).appear(e)}return function(){var t;if(localStorage.gameState||localStorage.gameName){if(localStorage.gameState){(t={}).whitesTurn=parseInt(localStorage.whitesTurn,10),t.gameTime=parseInt(localStorage.gameTime,10);try{t.gameState=JSON.parse(localStorage.gameState),t.castlingAllowed=JSON.parse(localStorage.castlingAllowed),t.moves=JSON.parse(localStorage.moves)}catch(e){localStorage.clear(),t=void 0}}localStorage.gameName&&(sync=new Sync).resumeGame(),game=new Game(t),e(!1)}else(menu=new Menu("#start")).appear();$("h1 a").on("click",function(){return e(!0),!1}),$(document).on("keydown",function(t){if(27===t.keyCode||27===t.which)return e(!0),!1}),$("#toggleAwareness").on("click",function(){$("#chess").hasClass("awareness")?$("#chess").removeClass("awareness"):$("#chess").addClass("awareness")}),$("#toggleFaq").on("click",function(){return $("#toggleFaq").toggleClass("active"),$("#flip").toggleClass("flipped"),!1}),$("#contact").on("click",function(){return $("#contact").off(),controller.flip($("#contact"),"vertical",250,function(){$("#contact").html("plainchess@timwoelfle.de"),$("#contact").attr("href","mailto:plainchess@timwoelfle.de?subject=PlainChess")}),!1}),localStorage.noAutoSave&&!sync&&($("#toggleAutoSave > h2 > a > span:last-child").html("off"),$("#pause > .tone55 > h2 span:first-child").css("background-position","100% 85.71%"))}(),{autoSave:!(localStorage.noAutoSave&&!sync),blink:function(e,t,n,i){$(e).animate({opacity:"0"},n/2,"easeOutQuad",function(){$(e).animate({opacity:"1"},n/2,"easeInQuad",function(){t>1?controller.blink(e,t-1,n,i):"function"==typeof i&&i()})})},spin:function(e,t){$(e).css("transition-property","transform").css("transition-duration",t+"ms").css("transition-timing-function","ease-out"),setTimeout(function(){$(e).css("transform","rotate(360deg)")})},flip:function(e,t,n,i){$(e).on("transitionend",function(){$(e).off("transitionend"),$(e).css("transition-timing-function","ease-out").removeClass(t),"function"==typeof i&&i()}).css("transition-property","transform").css("transition-duration",n/2+"ms").css("transition-timing-function","ease-in").addClass(t)}}}();